# API Contracts: PostgreSQL Migration to Supabase

**Date**: 2025-01-27  
**Feature**: PostgreSQL Migration to Supabase Cloud Service

## Overview

This migration feature does not introduce new API endpoints. The existing FastAPI endpoints will continue to work identically after migration to Supabase. This document confirms API contract compatibility and documents any considerations for Supabase deployment.

## API Compatibility

### Existing Endpoints (Unchanged)

All existing API endpoints remain fully compatible after migration to Supabase:

#### Patient Management Endpoints

- `GET /patients` - List all patients with search, pagination, and sorting
- `GET /patients/{patient_id}` - Get patient by patient ID
- `POST /patients` - Create a new patient
- `PUT /patients/{patient_id}` - Update a patient by patient ID
- `DELETE /patients/{patient_id}` - Delete a patient by patient ID

#### System Endpoints

- `GET /health` - Health check endpoint (includes database connectivity check)
- `GET /` - Root endpoint
- `GET /docs` - Swagger UI documentation
- `GET /redoc` - ReDoc documentation

### Contract Guarantees

**Response Format**: All endpoints maintain the same request/response formats:
- Request bodies use camelCase field names (e.g., `patientID`, `lastVisit`)
- Response bodies use camelCase field names
- Error responses follow FastAPI standard format
- Status codes remain unchanged

**Performance**: 
- API response times must remain within 200ms p95 (per SC-003)
- No degradation in performance after migration
- Database connection establishment completes in under 2 seconds (per SC-004)

**Data Integrity**:
- All patient data operations work identically
- Constraints and validations remain enforced
- Transaction behavior unchanged

## Supabase-Specific Considerations

### Connection String Format

The application uses environment variable `DATABASE_URL` which will be updated to Supabase connection string format:

```
postgresql+psycopg://[user]:[password]@[host]:[port]/[database]?sslmode=require
```

### SSL/TLS Requirements

- All connections to Supabase require SSL/TLS encryption
- Connection string must include `?sslmode=require` parameter
- This is automatically handled by Supabase connection strings

### Connection Pooling

- Application uses SQLAlchemy connection pooling (pool_size=5, max_overflow=10)
- Supabase connection pooler (port 6543) recommended for production
- Direct connection (port 5432) used for migrations

### HIPAA Compliance

- All API endpoints must maintain HIPAA compliance requirements
- SSL/TLS encryption enforced for all database connections
- Audit logging must capture all data access operations
- Access controls via Supabase Row Level Security (RLS) policies

## Testing Requirements

### Contract Tests

Contract tests must verify:
- All endpoints return expected response formats
- Error handling remains consistent
- Performance targets are met
- Data integrity is maintained

### Integration Tests

Integration tests must verify:
- Database connectivity with Supabase
- All CRUD operations work correctly
- Transaction behavior is correct
- Connection pooling works properly

## Migration Impact

### Zero API Changes

- No API endpoint changes required
- No request/response format changes
- No breaking changes to existing clients
- Frontend code requires no modifications

### Configuration Changes Only

- Update `DATABASE_URL` environment variable
- Update connection string format (add SSL parameter)
- No code changes to API routes or services

## Deployment Considerations

### Render Cloud Deployment

When deploying to Render:
1. Set `DATABASE_URL` environment variable to Supabase connection string
2. Ensure SSL/TLS is enabled (included in Supabase connection string)
3. Verify connection pooling configuration
4. Test all API endpoints after deployment

### Environment Variables

Required environment variables (unchanged, values updated):
- `DATABASE_URL`: Supabase connection string (replaces local PostgreSQL)
- `ENVIRONMENT`: `production` for Render deployment
- `CORS_ORIGINS`: Frontend domain(s)
- `PORT`: Automatically set by Render

## Verification

After migration, verify:
1. All API endpoints respond correctly
2. Response times meet performance targets
3. Health check endpoint reports database as "connected"
4. All CRUD operations work correctly
5. Error handling works as expected
6. API documentation (Swagger/ReDoc) is accessible

## OpenAPI Schema

The OpenAPI schema is automatically generated by FastAPI and available at:
- Swagger UI: `http://localhost:8000/docs` (development)
- ReDoc: `http://localhost:8000/redoc` (development)
- Production: `https://[render-url]/docs` and `https://[render-url]/redoc`

The schema remains unchanged after migration - only the database connection changes.

